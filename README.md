# Bing Image Generation API

Этот проект предоставляет стабильный и отказоустойчивый REST API для генерации изображений с использованием Microsoft Bing Image Creator. Он включает в себя функции автоматической ротации cookie-файлов для минимизации сбоев и встроенную панель мониторинга для отслеживания состояния нескольких запущенных экземпляров сервиса.

## Ключевые особенности

*   **REST API**: Простой и понятный API для генерации изображений.
*   **Поддержка моделей**: Генерация с использованием моделей DALL-E 3 и GPT-4o.
*   **Автоматическая ротация Cookie**: Сервис автоматически переключается на рабочие cookie-файлы при сбоях, обеспечивая непрерывную работу.
*   **Отказоустойчивость**: Система приостанавливает работу после серии неудач, чтобы предотвратить блокировку, и возобновляет ее через заданное время.
*   **Панель мониторинга**: Консольный дашборд для мониторинга состояния всех запущенных инстансов и пинга до удаленного хоста в реальном времени.
*   **Диагностика сбоев**: Монитор отображает последние неудачные промпты, помогая быстро выявить причину проблемы.

## Установка

1.  **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/theurs/bing10api.git
    cd bing10api
    ```

2.  **Создайте и активируйте виртуальное окружение:**

    ```bash
    python3 -m venv venv
    source venv/bin/activate  # Для Linux/macOS
    # venv\Scripts\activate  # Для Windows
    ```

3.  **Установите зависимости:**

    ```bash
    pip install -r requirements.txt
    ```

## Конфигурация

Все настройки находятся в файле `cfg.py`.

1.  **Настройка API-сервера и логов:**
    *   `ADDR`: IP-адрес, на котором будет запущен Flask-сервер (например, `'127.0.0.1'`).
    *   `PORT`: Порт для сервера (например, `'58796'`).
    *   `MAX_LOG_FILE_SIZE`: Максимальный размер лог-файла в байтах.
    *   `CMD_ON_STOP`: (Опционально) Команда, которая будет выполнена, когда сервис уходит в спящий режим из-за слишком большого количества ошибок (например, для отправки уведомления).

2.  **Настройка мониторинга:**
    *   `MONITOR_INSTANCES`: Список словарей, описывающих каждый инстанс вашего сервиса для панели мониторинга.
    *   `PING_TARGET`: (Опционально) IP-адрес или домен для ICMP-пинга. Если эта переменная отсутствует, пинг-монитор не будет отображаться.

    **Пример `cfg.py`:**
    ```python
    MAX_LOG_FILE_SIZE = 20 * 1024 * 1024

    ADDR = '127.0.0.1'
    PORT = '58796'
    
    # Команда будет выполняться перед уходом в спящий режим
    # CMD_ON_STOP = 'your-notification-command'

    # Адреса инстансов для панели мониторинга
    MONITOR_INSTANCES = [
        {"name": "Instance 1", "url": "http://127.0.0.1:58796/status"},
        {"name": "Instance 2", "url": "http://127.0.0.1:58797/status"},
        # Добавьте сюда остальные инстансы
    ]

    # Хост для пинг-монитора (опционально)
    PING_TARGET = "10.8.1.3"
    ```

3.  **Настройка Cookie-файлов:**
    *   Создайте в корне проекта файл `cookie.txt`. Поместите в него ваш валидный cookie-файл для Bing. Получить его можно с помощью расширений для браузера, таких как "Cookie Editor" (Export Header String). Если на сайте рисует а в боте нет то надо попробовать зайти в копилот и поговорить - возможно вылезет скрытая капча после которой всё нормализуется.
    *   Для работы ротации создайте дополнительные файлы с cookie, например, `cookie2.txt`, `cookie3.txt` и т.д. Сервис будет автоматически использовать их при сбоях основного.

## Запуск сервиса

Для запуска API-сервера выполните команду:

```bash
python bing10api.py
```

Сервер будет запущен по адресу, указанному в `cfg.py`.

## Использование API

### Эндпоинты для генерации

*   `POST /bing`: Генерирует 1 набор изображений.
*   `POST /bing2`: Повторяет запрос 2 раза.
*   `POST /bing10`: Повторяет запрос 10 раз.
*   `POST /bing20`: Повторяет запрос 20 раз.
*   `POST /bing_gpt`: Генерирует 1 набор изображений с использованием модели `gpt4o`.

#### Запрос

Отправьте POST-запрос с телом в формате JSON:

```json
{
  "prompt": "a beautiful cat in space"
}
```

#### Ответ (Успех)

```json
{
    "urls": [
        "https://...bing.com/th/id/...jpg",
        "https://...bing.com/th/id/...jpg"
    ]
}
```

#### Ответ (Ошибка)

```json
{
    "error": "No images generated"
}
```

#### Пример запроса с `curl`

```bash
curl -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "prompt": "a beautiful cat in space using gpt4o model"
    }' \
    http://127.0.0.1:58796/bing_gpt
```

### Эндпоинт для мониторинга

*   `GET /status`: Возвращает JSON-объект с текущим состоянием сервиса, включая список последних неудачных промптов.

#### Ответ `/status`

```json
{
    "service_status": "OK",
    "cookie_fail_count": 0,
    "total_fail_count": 0,
    "max_fail_for_rotate": 5,
    "max_fail_for_suspend": 20,
    "current_cookie": "cookie1.txt",
    "last_attempts": [
        {"time": "07-09-2025 21:30:00", "status": "OK"}
    ],
    "last_failed_prompts": [
        "a very long and complicated prompt that failed",
        "another prompt that was blocked"
    ]
}
```

#### Пример запроса с `curl`

```bash
curl http://127.0.0.1:58796/status
```

## Панель мониторинга (Дашборд)

Для отслеживания состояния всех ваших инстансов в одном окне используйте скрипт `monitor.py`.

1.  **Настройте инстансы**: Убедитесь, что все адреса ваших сервисов и `PING_TARGET` (если нужен) правильно указаны в `cfg.py`.

2.  **Установите зависимости для монитора**:
    ```bash
    pip install rich requests icmplib
    ```

3.  **Запустите мониторинг (ТРЕБУЮТСЯ ПРАВА)**:
    Для ICMP-пинга скрипту `monitor.py` нужны права на создание raw-сокетов.

    **Способ 1 (Рекомендуемый):** Выдать права бинарнику Python один раз.
    ```bash
    # Укажите путь к python в вашем virtualenv
    sudo setcap cap_net_raw+ep /path/to/your/venv/bin/python
    ```
    После этого запускайте скрипт как обычно:
    ```bash
    python monitor.py
    ```

    **Способ 2 (Простой):** Запускать через `sudo`.
    ```bash
    sudo python monitor.py
    ```

    Вы увидите интерактивную таблицу в консоли, которая обновляется и показывает статус каждого инстанса, используемый cookie-файл, историю попыток генерации и график задержки пинга. При возникновении ошибок генерации под основными таблицами появится дополнительная панель, в которой будут показаны тексты последних неудачных запросов. Это позволяет в реальном времени видеть, какие именно промпты не проходят, и оперативно реагировать.

## Описание файлов

*   `bing10api.py`: Основной файл с Flask API, который обрабатывает запросы, управляет логикой отказоустойчивости и предоставляет эндпоинт `/status`.
*   `bing_genimg_v3.py`: Класс `BingBrush`, который непосредственно взаимодействует с сайтом Bing для создания изображений.
*   `monitor.py`: Скрипт для запуска консольной панели мониторинга.
*   `cfg.py`: Файл конфигурации для настроек сети, логов и адресов инстансов.
*   `my_genimg.py`: Обертка над `bing_genimg_v3.py`, управляющая процессом генерации (повторы, блокировки).
*   `my_log.py`: Функции для логирования событий в файлы.
*   `rotate_cookie.py`: Скрипт, отвечающий за поиск и смену cookie-файлов при необходимости.
*   `utils.py`: Вспомогательные функции, используемые в проекте.
*   `requirements.txt`: Список зависимостей Python для установки.

## Важные примечания

*   **Безопасность**: В проекте отсутствует встроенная авторизация. Запускайте сервис в защищенной сети (локальной, VPN) или используйте обратный прокси-сервер (например, Nginx) для добавления аутентификации.
*   **Валидность Cookie**: Регулярно проверяйте, что ваши cookie-файлы в `cookieX.txt` действительны. Использование невалидных cookie — основная причина сбоев.
*   **Первый запуск**: При первом запуске сервис может инициализироваться несколько секунд.